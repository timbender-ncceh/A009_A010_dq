---
title: "A009 and A010 DQ Checks"
author: "NCCES_tim_bender"
date: "`r Sys.time()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load libraries and functions, message=FALSE, warning=FALSE, include=FALSE}
library(dplyr)
library(data.table)
library(readr)
library(glue)
library(crayon)

# Vars----
user.name    <- "michele knapp"
prov_prompt  <- "Diakonos, Inc. - Iredell County - Street Outreach - SO - PATH(20477)"

proj_summary.dash <- "Persons served during this reporting period:	Count
8. Number of persons contacted by PATH-funded staff this reporting period	
166
9. Number of new persons contacted this reporting period in a PATH Street Outreach project	
145
10. Number of new persons contacted this reporting period in a PATH Services Only project	
0
11. Total number of new persons contacted this reporting period (#9 + #10 = total new clients contacted)	
145
12a. Instances of contact this reporting period prior to date of enrollment	
59
12b. Total instances of contact during this reporting period	
100
13a. Number of new persons contacted this reporting period who could not be enrolled because of ineligibility for PATH	
17
13b. Number of new persons contacted this reporting period who could not be enrolled because provider was unable to locate the client	
17
14. Number of new persons contacted this reporting period who became enrolled in PATH	
17
15. Number with active, enrolled PATH status at any point during the date range	
18
16. Number of active, enrolled PATH clients receiving community mental health services through any funding source at any point during the reporting period	
14
"

proj_summary.a010 <- "Total Clients with Project Entry/Exit	185 
Total Clients with Services	152 
Total Services	572 
Total Clients with Referrals	19 
Total Referrals	41 
Total Clients with PATH enrollment	19 
Total PATH enrolled Clients with Services	20 
Total PATH enrolled Clients without Services	(1)
Total PATH enrolled Clients with Referrals	14 
Total PATH enrolled Clients without Referrals	5 
"
proj_summary.a009 <- "Entry Exit Provider Id	Unduplicated Client Count	Number of Entries	Count of Clients with DOE	Number of Exits
Diakonos, Inc. - Iredell County - Street Outreach - SO - PATH(20477)	185	199	129	153
"
a009_tabB_DOE_count.red.cells <- 20
#a009_tabB_DOE_count.green.cells <- 4
a009_tabB_colH.exited_colJ.missing_colK_missing <- 76 
a009_tabB_colK.no_colH.noexit <- 6
a009_tabB_colK.no_colL.missing <- 0

# tidy----
psd <- proj_summary.dash %>%
  strsplit(., "\t|\n") %>%
  unlist() %>%
  .[. != ""]

psd.df <- data.frame(var1 = grep("^\\d{1,}\\w{0,1}\\. ", psd, value = T), 
                     var2 = as.numeric(psd[!psd %in% grep("^\\d{1,}\\w{0,1}\\. ", psd, value = T)][3:length(psd[!psd %in% grep("^\\d{1,}\\w{0,1}\\. ", psd, value = T)])] ))

colnames(psd.df) <- psd[1:2]

psd.df <- as_tibble(psd.df)

proj_id   <- prov_prompt %>%
  gsub("^.*\\(|\\)$", "", .) %>% as.numeric()
proj_name <- prov_prompt

# Funs-----
funA009 <- function(sum.data, 
                    provider.prompt, 
                    username){
  require(readr)
  temp.pp <- provider.prompt %>% trimws()
  temp.pid <- temp.pp %>%
    strsplit(., split = "\\(|\\)$") %>%
    unlist() %>%
    as.numeric() %>%
    .[!is.na(.)]
  temp.uid <- username %>%
    strsplit(., " ") %>%
    unlist() %>%
    strsplit(., "")
  if(length(temp.uid) == 2){
    temp.uid <- temp.uid %>%
      lapply(., first) %>%
      unlist() %>%
      tolower() %>%
      paste(., sep = "", collapse = "")
  
  }else{
    temp.uid <- temp.uid %>% 
      unlist() %>%
      tolower() %>%
      paste(., sep = "", collapse = "") %>%
      substr(., 0, 2)
  }
  temp.uid <- paste(temp.pid, temp.uid, "A009", sep = "_", 
                    collapse = "_")
    
  
  sum.df <- read_tsv(sum.data)
  # sum.df$value <- gsub("\\(", "-", sum.df$value) %>%
  #   gsub("\\)|,", "", .) %>%
  #   as.numeric()
  #sum.df$project_id <- temp.pid
  #sum.df$uid <- temp.uid
  sum.df$`Entry Exit Provider Id` <- temp.pid
  
  colnames(sum.df) <- c("prov_id", 
                        "undup_clients", 
                        "n_entries", 
                        "n_clients_wDOE", 
                        "n_exits")
  
  out.df <- sum.df %>% as.data.table()
  return(out.df)
}

funA010 <- function(sum.data, 
                  provider.prompt, 
                  username){
  require(readr)
  temp.pp <- provider.prompt %>% trimws()
  temp.pid <- temp.pp %>%
    strsplit(., split = "\\(|\\)$") %>%
    unlist() %>%
    as.numeric() %>%
    .[!is.na(.)]
  temp.uid <- username %>%
    strsplit(., " ") %>%
    unlist() %>%
    strsplit(., "")
  if(length(temp.uid) == 2){
    temp.uid <- temp.uid %>%
      lapply(., first) %>%
      unlist() %>%
      tolower() %>%
      paste(., sep = "", collapse = "")
  
  }else{
    temp.uid <- temp.uid %>% 
      unlist() %>%
      tolower() %>%
      paste(., sep = "", collapse = "") %>%
      substr(., 0, 2)
  }
  temp.uid <- paste(temp.pid, temp.uid, "A010", sep = "_", 
                    collapse = "_")
    
  
  sum.df <- read_tsv(sum.data, 
                     col_names = c("variable", "value"))
  sum.df$value <- gsub("\\(", "-", sum.df$value) %>%
    gsub("\\)|,", "", .) %>%
    as.numeric()
  #sum.df$project_id <- temp.pid
  #sum.df$uid <- temp.uid
  
  out.df <- sum.df %>% as.data.table()
  return(out.df)
}


```


## REPORT DIRECTIONS
Download A009 and A010 Report with the specifications listed below.  The pull up the PATH dashboard (not a report; just a dashboard in HMIS) and compare them the A0XX reports to the dash and see where the differences are and log them.

#### GitHub Links:
* Project Website (i.e. this document): https://timbender-ncceh.github.io/A009_A010_dq/

<!-- * Repository: https://github.com/timbender-ncceh/A009_A010_dq/tree/main -->
* Projet Issues / Comments: https://github.com/timbender-ncceh/A009_A010_dq/issues

#### ZenGuide Links:

<!-- * ZenGuide_General: https://ncceh.zendesk.com/ -->
* A009: https://ncceh.zendesk.com/hc/en-us/articles/16245113253523-A009-PATH-Details-Data-Quality-Report-Guide
* A010: https://ncceh.zendesk.com/hc/en-us/articles/16273061844883-A010-PATH-Services-Referrals-Report-Guide
* PATH_Dashboard: https://ncceh.zendesk.com/hc/en-us/articles/15097522537235

#### Project How-To
* From Login 
  - Shadow user [redacted] or [redacted]
  - Connect to BusinessObjects
* Folder Directory 
  - See ZenGuide
* Query Setup
  - See ZenGuide for filetype and output directions
  - Click the three dot symbol (â‹¯) not the name of the report to set it up and run it.  This allows for report configuration. 
  - You will need to select one provider_id (see notes below) and compare to PA

```{r message=FALSE, warning=FALSE, include=FALSE, paged.print=TRUE}
tbl1 <- expand.grid(report = c("A009", "A010"), 
            #comparison = "PATH_dash",
            start_date = "07-01-2022",
            end_date   = "06-30-2023",
            notes = "SSO+SO+PATH",
            pid = sort(c(20538, 20539, 
                            20478, 20477))) %>%
  as.data.table()

tbl2 <- data.frame(uid = NA, 
                   pid = tbl1$pid, 
                   shadow_user = c(rep("michele knapp", 4), 
                                   rep("benjamin horton", 4)))
out1 <- full_join(tbl2,tbl1) %>%
  .[!duplicated(.),]

rownames(out1) <- 1:nrow(out1)

out1$uid <- paste(out1$pid, 
                  # paste(substr(out1$pid,
                  #       start = nchar(out1$pid)-2, 
                  #       stop = nchar(out1$pid)), 
      unlist(lapply(lapply(strsplit(out1$shadow_user, " "), 
         substr, start = 1, stop = 1), 
         paste, sep = "", collapse = "")), 
      out1$report,
      sep = "_") 

print(out1)

```

## QA INPUTS AND RESULTS
### Provider Inputs:
```{r echo=FALSE, message=FALSE, warning=FALSE}
cat(glue("Project ID:\t{proj_id}\nProv. Name:\t{proj_name}"))
```

### PATH Dashboard Results
#### Report Summary Data:
```{r echo=FALSE, message=FALSE, warning=FALSE}
print(psd.df)
```


### A009 Results
#### Report Summary Data:
```{r echo=FALSE, message=FALSE, warning=FALSE}
da009 <- funA009(proj_summary.a009, 
                 prov_prompt, 
                 user.name)
print(da009)
```

<!-- #### Review Steps: -->
<!-- [not sure - read ZenGuide and started answering the review questions but they seemed too specific for this QA Task] -->

<!-- * Date of Engagement recorded prior to Project Start Date or after the Project Exit Date. -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{a009_tabB_DOE_count.red.cells}")) -->
<!-- ``` -->

<!-- * Exited clients with a missing Date of Status Determination &/or PATH enrollment Status. These data elements are required by the time a client exits the PATH project. -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{a009_tabB_colH.exited_colJ.missing_colK_missing}")) -->
<!-- ``` -->

<!-- * Clients marked as "No" for PATH enrollment but are missing a Project Exit Date -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{a009_tabB_colK.no_colH.noexit}")) -->
<!-- ``` -->

<!-- * Clients marked as "No" for PATH enrollment but are missing the follow up "if no..." data element. -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{a009_tabB_colK.no_colL.missing}")) -->
<!-- ``` -->
<!-- * Client is missing a SOAR connection response. This is required at Project Start & can be updated throughout the project stay. -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{}")) -->
<!-- ``` -->
<!-- * REVIEW ONLY (may not be an error) Any client in the project more than 90days without Date of Engagement. This could be accurate but worth confirming -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{}")) -->
<!-- ``` -->
<!-- * REVIEW ONLY (may not be an error) Any client without a PATH status determination and PATH enrollment but has been in the project more than 90days. -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{}")) -->
<!-- ``` -->
<!-- * REVIEW ONLY: Any client appearing twice for the same project. Clients should only have one project stay at a time. Project enrollment dates should not overlap. -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{}")) -->
<!-- ``` -->

### A010 Results
#### Report Summary Data:
```{r A010 Data, echo=FALSE, message=FALSE, warning=FALSE}

da010 <- funA010(sum.data = proj_summary.a010, 
                 provider.prompt = prov_prompt, 
                 username = user.name)
print(da010)

```

<!-- #### Review Steps: -->
<!-- [hidden for now b/c I don't think this is the actual point of this exercise] -->


<!-- * Confirm the total clients with a project entry/exit appears accurate for the number of clients served/contacted during the reporting period.   -->
<!--   - [Line 1] == [Line 2] + [Line 4] + [Line 6] -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{da010$value[1]} == {da010$value[2]} + {da010$value[4]} + {da010$value[6]}\n{da010$value[1] == da010$value[2] + da010$value[4] + da010$value[6]}")) -->
<!-- ``` -->

<!-- * Confirm the number of clients marked as PATH enrolled appears accurate.   -->
<!--   - [Line 6] == [Line 7] + [Line 8] & [Line 6] == [Line 9] + [Line 10] -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{da010$value[6]} == {da010$value[7]} + {da010$value[8]} & {da010$value[6]} == {da010$value[9]} + {da010$value[10]}\n{da010$value[6] == da010$value[7] + da010$value[8] & da010$value[6] == da010$value[9] + da010$value[10]}")) -->
<!-- ```   -->
<!-- * The total clients with PATH enrollment should equal the "total PATH enrolled clients with services" + "total PATH enrolled clients without services".   -->
<!--   - [Line 6] == [Line 7] + [Line 8] -->
<!--   - If the numbers do not add up, you will want to check for duplicate/dual enrollments (the same client served more than once during the reporting period).  -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{da010$value[6]} == {da010$value[7]} + {da010$value[8]}\n{da010$value[6] == da010$value[7] + da010$value[8]}")) -->
<!-- ``` -->

<!-- * The total clients with PATH enrollment should also equal the "total PATH enrolled clients with referrals" + "total PATH enrolled clients without referrals".   -->
<!--   - [Line 6] == [Line 9] + [Line 10]  -->
<!--   - If the numbers do not add up, you will want to check for duplicate/dual enrollments (the same client served more than once during the reporting period). -->
<!-- ```{r echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- cat(glue("{da010$value[6]} == {da010$value[9]} + {da010$value[10]}\n{da010$value[6] == da010$value[9] + da010$value[10]}")) -->

<!-- ``` -->


### QA FINDINGS
[to be completed]

<!-- #### Current Status -->
<!-- ```{r A010 status, echo=FALSE, message=FALSE, warning=FALSE} -->
<!-- tbl010_status <- out1[out1$report =="A010",c("uid","pid")] %>% -->
<!--   mutate(.,  -->
<!--          report_dl = F,  -->
<!--          QA_comp   = F) %>% -->
<!--   .[!colnames(.) %in% "pid"] -->
<!-- print(tbl010_status) -->
<!-- ``` -->



#### Identified QA Issues


## CONCLUSION 


```{r Silent Chunk to copy html output to clipboard, message=TRUE, warning=TRUE, include=FALSE}
# library(htmltools)
# library(utils)
# writeClipboard(str = includeHTML("a009_a010.html"))

if(file.exists("a009_a010.html")){
  file.rename(from = "a009_a010.html", 
            to = "index.html")
}


```

